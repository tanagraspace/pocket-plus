name: C Build & Test

on:
  push:
    branches: [main]
    paths:
      - 'implementations/c/**'
      - '.github/workflows/c-build.yml'
  pull_request:
    paths:
      - 'implementations/c/**'
      - '.github/workflows/c-build.yml'

permissions:
  contents: write

jobs:
  build-and-test:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build library and CLI
        working-directory: implementations/c
        run: make

      - name: Install junit2html
        run: pip3 install --break-system-packages junit2html || pip3 install junit2html

      - name: Run unit tests
        working-directory: implementations/c
        run: |
          echo "## Unit Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          make test 2>&1 | tee test-output.txt
          cat test-output.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Generate test report
        working-directory: implementations/c
        run: make test-report

      - name: Run CLI round-trip tests
        working-directory: implementations/c
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## CLI Round-trip Tests" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          make test-cli 2>&1 | tee cli-test-output.txt
          cat cli-test-output.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Parse test results
        working-directory: implementations/c
        run: |
          # Extract pass/fail counts
          TOTAL_PASSED=$(grep -o '[0-9]*/[0-9]* tests passed' test-output.txt | awk -F'/' '{sum+=$1} END {print sum}')
          TOTAL_TESTS=$(grep -o '[0-9]*/[0-9]* tests passed' test-output.txt | awk -F'/' '{s+=$2} END {print s}' | awk '{print $1}')

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Tests Passed | $TOTAL_PASSED |" >> $GITHUB_STEP_SUMMARY
          echo "| Total Tests | $TOTAL_TESTS |" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | ${{ matrix.os }} |" >> $GITHUB_STEP_SUMMARY

      - name: Test vector validation
        working-directory: implementations/c
        shell: bash
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Vector Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Vector | Input | Output | Ratio | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|--------|-------|--------|" >> $GITHUB_STEP_SUMMARY

          # Run test_vectors and capture output
          ./build/test_vectors 2>&1 | tee vector-output.txt

          # Parse results
          # Format: "  test_vector_simple...    Input: 9000 bytes â†’ Compressed: 641 bytes (ratio: 14.04x)"
          grep "test_vector_" vector-output.txt | grep "Input:" | while IFS= read -r line; do
            name=$(echo "$line" | sed 's/.*test_vector_//' | sed 's/\.\.\..*//' | tr '_' '-')
            input=$(echo "$line" | sed 's/.*Input: //' | sed 's/ bytes.*//')
            output=$(echo "$line" | sed 's/.*Compressed: //' | sed 's/ bytes.*//')
            ratio=$(echo "$line" | sed 's/.*ratio: //' | sed 's/).*//')
            echo "| $name | $input bytes | $output bytes | $ratio | :white_check_mark: |" >> $GITHUB_STEP_SUMMARY
          done

      - name: Run valgrind memory check
        if: matrix.os == 'ubuntu-latest'
        working-directory: implementations/c
        run: |
          sudo apt-get install -y valgrind
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Valgrind Memory Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          valgrind --leak-check=full --error-exitcode=1 ./build/test_vectors 2>&1 | tee valgrind-output.txt
          echo '```' >> $GITHUB_STEP_SUMMARY
          grep -E "ERROR SUMMARY|definitely lost|indirectly lost|possibly lost" valgrind-output.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Upload test artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ matrix.os }}
          path: |
            implementations/c/test-output.txt
            implementations/c/cli-test-output.txt
            implementations/c/vector-output.txt
            implementations/c/valgrind-output.txt
            implementations/c/build/docs/tests/report.xml
            implementations/c/build/docs/tests/html/
          retention-days: 7

  coverage:
    runs-on: ubuntu-latest
    needs: build-and-test

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install lcov
        run: sudo apt-get install -y lcov

      - name: Run tests with coverage
        working-directory: implementations/c
        run: make coverage 2>&1 | tee coverage-output.txt

      - name: Generate coverage report
        working-directory: implementations/c
        run: make coverage-html

      - name: Parse coverage summary
        working-directory: implementations/c
        run: |
          echo "## Code Coverage" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| File | Line Coverage |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------------|" >> $GITHUB_STEP_SUMMARY

          # Parse gcov output
          grep -E "^File 'src/|Lines executed:" coverage-output.txt | paste - - | while IFS= read -r line; do
            file=$(echo "$line" | sed "s/.*File 'src\///" | sed "s/'.*//")
            coverage=$(echo "$line" | sed "s/.*Lines executed://" | sed "s/ of.*//" | tr -d ' ')
            echo "| $file | $coverage |" >> $GITHUB_STEP_SUMMARY
          done

          echo "" >> $GITHUB_STEP_SUMMARY

          # Calculate and display overall coverage
          COVERAGE_PCT=$(lcov --summary build/coverage/coverage.info 2>&1 | grep "lines" | sed 's/.*: //' | sed 's/%.*//')
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Overall Coverage: ${COVERAGE_PCT}%**" >> $GITHUB_STEP_SUMMARY

      - name: Upload coverage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: implementations/c/build/docs/coverage/html
          retention-days: 7

      - name: Update coverage badges
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        working-directory: implementations/c
        run: |
          # Extract line and function coverage from lcov
          LINES=$(lcov --summary build/coverage/coverage.info 2>&1 | grep "lines" | sed 's/.*: //' | sed 's/%.*//')
          FUNCS=$(lcov --summary build/coverage/coverage.info 2>&1 | grep "functions" | sed 's/.*: //' | sed 's/%.*//')

          echo "Line coverage: ${LINES}%"
          echo "Function coverage: ${FUNCS}%"

          # Determine badge color based on coverage
          get_color() {
            local cov=$1
            if (( $(echo "$cov >= 90" | bc -l) )); then
              echo "#97ca00"
            elif (( $(echo "$cov >= 80" | bc -l) )); then
              echo "#a4a61d"
            elif (( $(echo "$cov >= 70" | bc -l) )); then
              echo "#dfb317"
            else
              echo "#e05d44"
            fi
          }

          LINES_COLOR=$(get_color $LINES)
          FUNCS_COLOR=$(get_color $FUNCS)

          # Generate line coverage badge
          cat > assets/coverage-lines.svg << SVGEOF
          <svg xmlns="http://www.w3.org/2000/svg" width="90" height="20">
          <linearGradient id="b" x2="0" y2="100%"><stop offset="0" stop-color="#bbb" stop-opacity=".1"/><stop offset="1" stop-opacity=".1"/></linearGradient>
          <mask id="a"><rect width="90" height="20" rx="3" fill="#fff"/></mask>
          <g mask="url(#a)"><path fill="#555" d="M0 0h45v20H0z"/><path fill="${LINES_COLOR}" d="M45 0h45v20H45z"/><path fill="url(#b)" d="M0 0h90v20H0z"/></g>
          <g fill="#fff" text-anchor="middle" font-family="DejaVu Sans,Verdana,Geneva,sans-serif" font-size="11">
          <text x="22.5" y="15" fill="#010101" fill-opacity=".3">lines</text>
          <text x="22.5" y="14">lines</text>
          <text x="67" y="15" fill="#010101" fill-opacity=".3">${LINES}%</text>
          <text x="67" y="14">${LINES}%</text></g></svg>
          SVGEOF

          # Generate function coverage badge
          cat > assets/coverage-functions.svg << SVGEOF
          <svg xmlns="http://www.w3.org/2000/svg" width="106" height="20">
          <linearGradient id="b" x2="0" y2="100%"><stop offset="0" stop-color="#bbb" stop-opacity=".1"/><stop offset="1" stop-opacity=".1"/></linearGradient>
          <mask id="a"><rect width="106" height="20" rx="3" fill="#fff"/></mask>
          <g mask="url(#a)"><path fill="#555" d="M0 0h61v20H0z"/><path fill="${FUNCS_COLOR}" d="M61 0h45v20H61z"/><path fill="url(#b)" d="M0 0h106v20H0z"/></g>
          <g fill="#fff" text-anchor="middle" font-family="DejaVu Sans,Verdana,Geneva,sans-serif" font-size="11">
          <text x="30.5" y="15" fill="#010101" fill-opacity=".3">functions</text>
          <text x="30.5" y="14">functions</text>
          <text x="83" y="15" fill="#010101" fill-opacity=".3">${FUNCS}%</text>
          <text x="83" y="14">${FUNCS}%</text></g></svg>
          SVGEOF

      - name: Commit coverage badges
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        working-directory: implementations/c
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add assets/coverage-lines.svg assets/coverage-functions.svg
          git diff --staged --quiet || git commit -m "chore(c): update coverage badges [skip ci]"
          git push

  docs:
    runs-on: ubuntu-latest
    needs: build-and-test

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Doxygen
        run: sudo apt-get install -y doxygen

      - name: Download Doxygen Awesome CSS
        working-directory: implementations/c
        run: |
          mkdir -p doxygen-awesome-css
          curl -sL https://raw.githubusercontent.com/jothepro/doxygen-awesome-css/v2.3.4/doxygen-awesome.css -o doxygen-awesome-css/doxygen-awesome.css
          curl -sL https://raw.githubusercontent.com/jothepro/doxygen-awesome-css/v2.3.4/doxygen-awesome-sidebar-only.css -o doxygen-awesome-css/doxygen-awesome-sidebar-only.css

      - name: Build library
        working-directory: implementations/c
        run: make

      - name: Generate documentation
        working-directory: implementations/c
        run: make docs

      - name: Add docs summary
        working-directory: implementations/c
        run: |
          echo "## API Documentation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Doxygen documentation generated successfully." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Download the **docs-api** artifact to view the HTML documentation." >> $GITHUB_STEP_SUMMARY

      - name: Upload documentation artifacts
        uses: actions/upload-artifact@v4
        with:
          name: docs-api
          path: implementations/c/build/docs/api/html
          retention-days: 7
