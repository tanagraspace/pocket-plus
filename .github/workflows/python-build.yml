name: Python Build

on:
  push:
    branches: [main]
    paths:
      - 'implementations/python/**'
      - '.github/workflows/python-build.yml'
  pull_request:
    paths:
      - 'implementations/python/**'
      - '.github/workflows/python-build.yml'

permissions:
  contents: write

defaults:
  run:
    working-directory: implementations/python

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11', '3.12']

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Check formatting with ruff
        run: ruff format --check .

      - name: Lint with ruff
        run: ruff check .

      - name: Type check with mypy
        run: mypy pocketplus

      - name: Run tests with coverage
        run: |
          mkdir -p build/docs
          pytest -v --fast --cov=pocketplus \
            --cov-report=html:build/docs/coverage \
            --cov-report=xml:build/docs/coverage.xml \
            --cov-report=term \
            --html=build/docs/tests/report.html --self-contained-html \
            | tee coverage-output.txt

      - name: Generate API docs
        if: matrix.python-version == '3.11'
        run: pdoc -d google pocketplus -o build/docs/api

      - name: Upload docs artifacts
        if: matrix.python-version == '3.11'
        uses: actions/upload-artifact@v4
        with:
          name: python-docs
          path: implementations/python/build/docs/

      - name: Update coverage badge
        if: matrix.python-version == '3.11' && github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          # Extract coverage percentage
          COVERAGE=$(grep "TOTAL" coverage-output.txt | awk '{print $NF}' | sed 's/%//')
          echo "Coverage: ${COVERAGE}%"

          # Determine badge color based on coverage
          if (( $(echo "$COVERAGE >= 90" | bc -l) )); then
            COLOR="#97ca00"
          elif (( $(echo "$COVERAGE >= 80" | bc -l) )); then
            COLOR="#a4a61d"
          elif (( $(echo "$COVERAGE >= 70" | bc -l) )); then
            COLOR="#dfb317"
          else
            COLOR="#e05d44"
          fi

          # Create assets directory if needed
          mkdir -p assets

          # Generate coverage badge
          cat > assets/coverage.svg << SVGEOF
          <svg xmlns="http://www.w3.org/2000/svg" width="106" height="20">
          <linearGradient id="b" x2="0" y2="100%"><stop offset="0" stop-color="#bbb" stop-opacity=".1"/><stop offset="1" stop-opacity=".1"/></linearGradient>
          <mask id="a"><rect width="106" height="20" rx="3" fill="#fff"/></mask>
          <g mask="url(#a)"><path fill="#555" d="M0 0h61v20H0z"/><path fill="${COLOR}" d="M61 0h45v20H61z"/><path fill="url(#b)" d="M0 0h106v20H0z"/></g>
          <g fill="#fff" text-anchor="middle" font-family="DejaVu Sans,Verdana,Geneva,sans-serif" font-size="11">
          <text x="30.5" y="15" fill="#010101" fill-opacity=".3">coverage</text>
          <text x="30.5" y="14">coverage</text>
          <text x="83" y="15" fill="#010101" fill-opacity=".3">${COVERAGE}%</text>
          <text x="83" y="14">${COVERAGE}%</text></g></svg>
          SVGEOF

      - name: Commit coverage badge
        if: matrix.python-version == '3.11' && github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add assets/coverage.svg
          git diff --staged --quiet || git commit -m "chore(python): update coverage badge [skip ci]"
          git push
