name: Build & Deploy Docs

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build-c-docs:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y doxygen lcov

      - name: Build and test with coverage
        working-directory: implementations/c
        run: make coverage

      - name: Run tests and generate HTML report
        working-directory: implementations/c
        run: |
          mkdir -p build/docs/tests
          make test 2>&1 | tee build/test-output.txt
          ../../scripts/generate-test-report.sh build/test-output.txt build/docs/tests/index.html "POCKET+ C Test Report"

      - name: Generate coverage HTML
        working-directory: implementations/c
        run: make coverage-html

      - name: Generate API docs
        working-directory: implementations/c
        run: make docs

      - name: Prepare C artifacts
        run: |
          mkdir -p _site/c
          cp -r implementations/c/build/docs/api/html _site/c/api
          cp -r implementations/c/build/docs/coverage/html _site/c/coverage
          cp -r implementations/c/build/docs/tests _site/c/tests

      - name: Upload C docs artifact
        uses: actions/upload-artifact@v4
        with:
          name: c-docs
          path: _site/c

  build-cpp-docs:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y cmake lcov doxygen graphviz

      - name: Build and test with coverage
        working-directory: implementations/cpp
        run: make coverage

      - name: Run tests and generate HTML report
        working-directory: implementations/cpp
        run: |
          mkdir -p build/docs/tests
          make test 2>&1 | tee build/test-output.txt
          ../../scripts/generate-test-report.sh build/test-output.txt build/docs/tests/index.html "POCKET+ C++ Test Report"

      - name: Generate coverage HTML
        working-directory: implementations/cpp
        run: make coverage-html

      - name: Generate API docs
        working-directory: implementations/cpp
        run: make docs

      - name: Prepare C++ artifacts
        run: |
          mkdir -p _site/cpp/api _site/cpp/coverage _site/cpp/tests
          cp -r implementations/cpp/build/docs/api/html/* _site/cpp/api/ 2>/dev/null || echo "No API docs"
          cp -r implementations/cpp/build/docs/coverage/html/* _site/cpp/coverage/ 2>/dev/null || echo "No coverage report"
          cp -r implementations/cpp/build/docs/tests/* _site/cpp/tests/ 2>/dev/null || echo "No test report"

      - name: Upload C++ docs artifact
        uses: actions/upload-artifact@v4
        with:
          name: cpp-docs
          path: _site/cpp

  build-python-docs:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        working-directory: implementations/python
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run tests with coverage
        working-directory: implementations/python
        run: |
          mkdir -p build/docs
          pytest -v --fast --cov=pocketplus \
            --cov-report=html:build/docs/coverage \
            --html=build/docs/tests/index.html --self-contained-html

      - name: Generate API docs
        working-directory: implementations/python
        run: pdoc -d google pocketplus -o build/docs/api

      - name: Prepare Python artifacts
        run: |
          mkdir -p _site/python
          cp -r implementations/python/build/docs/api _site/python/api
          cp -r implementations/python/build/docs/coverage _site/python/coverage
          cp -r implementations/python/build/docs/tests _site/python/tests

      - name: Upload Python docs artifact
        uses: actions/upload-artifact@v4
        with:
          name: python-docs
          path: _site/python

  build-go-docs:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Install gotestsum and junit2html
        run: |
          go install gotest.tools/gotestsum@v1.12.0
          pip install junit2html

      - name: Run tests and generate report
        working-directory: implementations/go
        run: |
          mkdir -p build/docs/tests
          gotestsum --junitfile build/docs/tests/report.xml --format testname -- -v ./pocketplus/
          junit2html build/docs/tests/report.xml build/docs/tests/index.html

      - name: Generate coverage HTML
        working-directory: implementations/go
        run: |
          mkdir -p build/docs/coverage
          go test -coverprofile=build/coverage.out ./pocketplus/...
          go tool cover -html=build/coverage.out -o build/docs/coverage/index.html

      - name: Generate API docs
        working-directory: implementations/go
        run: |
          mkdir -p build/docs/api
          ./scripts/generate-api-docs.sh build/docs/api

      - name: Prepare Go artifacts
        run: |
          mkdir -p _site/go
          cp -r implementations/go/build/docs/api _site/go/api
          cp -r implementations/go/build/docs/coverage _site/go/coverage
          cp -r implementations/go/build/docs/tests _site/go/tests

      - name: Upload Go docs artifact
        uses: actions/upload-artifact@v4
        with:
          name: go-docs
          path: _site/go

  build-rust-docs:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-tarpaulin and cargo-nextest
        run: |
          cargo install cargo-tarpaulin
          cargo install cargo-nextest

      - name: Install junit2html
        run: pip install junit2html

      - name: Run tests and generate report
        working-directory: implementations/rust
        run: |
          mkdir -p build/docs/tests
          cargo nextest run --release --profile ci
          junit2html target/nextest/ci/junit.xml build/docs/tests/index.html

      - name: Generate coverage HTML
        working-directory: implementations/rust
        run: |
          mkdir -p build/docs/coverage
          cargo tarpaulin --out Html --output-dir build/docs/coverage --exclude-files "src/bin/*"
          mv build/docs/coverage/tarpaulin-report.html build/docs/coverage/index.html

      - name: Generate API docs
        working-directory: implementations/rust
        run: |
          cargo doc --no-deps --document-private-items
          cp -r target/doc build/docs/api

      - name: Prepare Rust artifacts
        run: |
          mkdir -p _site/rust
          cp -r implementations/rust/build/docs/api _site/rust/api
          cp -r implementations/rust/build/docs/coverage _site/rust/coverage
          cp -r implementations/rust/build/docs/tests _site/rust/tests

      - name: Upload Rust docs artifact
        uses: actions/upload-artifact@v4
        with:
          name: rust-docs
          path: _site/rust

  build-java-docs:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      - name: Run tests and generate report
        working-directory: implementations/java
        run: |
          mkdir -p build/docs/tests
          mvn test surefire-report:report-only site -DgenerateReports=false
          cp target/site/surefire-report.html build/docs/tests/index.html
          cp -r target/site/css build/docs/tests/ 2>/dev/null || true
          cp -r target/site/images build/docs/tests/ 2>/dev/null || true

      - name: Generate coverage HTML
        working-directory: implementations/java
        run: |
          mkdir -p build/docs/coverage
          mvn verify jacoco:report
          cp -r target/site/jacoco/* build/docs/coverage/

      - name: Generate API docs
        working-directory: implementations/java
        run: |
          mvn javadoc:javadoc
          cp -r target/site/apidocs build/docs/api

      - name: Prepare Java artifacts
        run: |
          mkdir -p _site/java
          cp -r implementations/java/build/docs/api _site/java/api
          cp -r implementations/java/build/docs/coverage _site/java/coverage
          cp -r implementations/java/build/docs/tests _site/java/tests

      - name: Upload Java docs artifact
        uses: actions/upload-artifact@v4
        with:
          name: java-docs
          path: _site/java

  deploy:
    needs: [build-c-docs, build-cpp-docs, build-python-docs, build-go-docs, build-rust-docs, build-java-docs]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - uses: actions/checkout@v4

      - name: Download C docs
        uses: actions/download-artifact@v4
        with:
          name: c-docs
          path: _site/c

      - name: Download C++ docs
        uses: actions/download-artifact@v4
        with:
          name: cpp-docs
          path: _site/cpp

      - name: Download Python docs
        uses: actions/download-artifact@v4
        with:
          name: python-docs
          path: _site/python

      - name: Download Go docs
        uses: actions/download-artifact@v4
        with:
          name: go-docs
          path: _site/go

      - name: Download Rust docs
        uses: actions/download-artifact@v4
        with:
          name: rust-docs
          path: _site/rust

      - name: Download Java docs
        uses: actions/download-artifact@v4
        with:
          name: java-docs
          path: _site/java

      - name: Copy landing page
        run: cp docs/index.html _site/index.html

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
