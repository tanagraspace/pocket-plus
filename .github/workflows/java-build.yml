name: Java Build & Test

on:
  push:
    branches: [main]
    paths:
      - 'implementations/java/**'
      - '.github/workflows/java-build.yml'
  pull_request:
    paths:
      - 'implementations/java/**'
      - '.github/workflows/java-build.yml'

permissions:
  contents: write

defaults:
  run:
    working-directory: implementations/java

jobs:
  build-and-test:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        java: ['11', '17', '21', '25']

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK ${{ matrix.java }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ matrix.java }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Check formatting
        if: matrix.java != '11'
        run: mvn spotless:check

      - name: Run checkstyle
        if: matrix.java != '11'
        run: mvn checkstyle:check

      - name: Run SpotBugs
        if: matrix.java != '11'
        run: mvn spotbugs:check

      - name: Build
        run: mvn package -DskipTests

      - name: Run tests
        run: |
          echo "## Unit Test Results (${{ matrix.os }} - Java ${{ matrix.java }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          mkdir -p build/docs/tests
          mvn test 2>&1 | tee build/test-output.txt
          cat build/test-output.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Run CLI round-trip tests
        run: |
          echo "## CLI Round-trip Tests (${{ matrix.os }} - Java ${{ matrix.java }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          ./tests/test_cli.sh 2>&1 | tee -a $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Upload test artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ matrix.os }}-java${{ matrix.java }}
          path: |
            implementations/java/build/test-output.txt
            implementations/java/target/surefire-reports/
          retention-days: 7

  coverage:
    runs-on: ubuntu-latest
    needs: build-and-test

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      - name: Run tests with coverage
        run: |
          mkdir -p build/coverage
          mvn verify jacoco:report 2>&1 | tee coverage-output.txt

      - name: Copy coverage report
        run: cp -r target/site/jacoco build/coverage/

      - name: Parse coverage summary
        run: |
          echo "## Code Coverage" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Extract coverage percentage from JaCoCo report
          if [ -f target/site/jacoco/index.html ]; then
            COVERAGE=$(grep -oP 'Total[^%]*\K\d+' target/site/jacoco/index.html | head -1 || echo "0")
          else
            COVERAGE="0"
          fi

          echo "**Overall Coverage: ${COVERAGE}%**" >> $GITHUB_STEP_SUMMARY

      - name: Upload coverage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: implementations/java/build/coverage
          retention-days: 7

      - name: Update coverage badge
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          # Extract coverage percentage from JaCoCo CSV
          if [ -f target/site/jacoco/jacoco.csv ]; then
            # Sum INSTRUCTION_COVERED and INSTRUCTION_MISSED from all rows
            COVERED=$(awk -F',' 'NR>1 {sum+=$4} END {print sum}' target/site/jacoco/jacoco.csv)
            MISSED=$(awk -F',' 'NR>1 {sum+=$5} END {print sum}' target/site/jacoco/jacoco.csv)
            if [ "$((COVERED + MISSED))" -gt 0 ]; then
              COVERAGE=$(awk "BEGIN {printf \"%.1f\", ($COVERED / ($COVERED + $MISSED)) * 100}")
            else
              COVERAGE="0"
            fi
          else
            COVERAGE="0"
          fi
          COVERAGE_INT=$(printf "%.0f" "$COVERAGE")
          echo "Coverage: ${COVERAGE_INT}%"

          # Determine badge color based on coverage
          if [ "$COVERAGE_INT" -ge 90 ]; then
            COLOR="#97ca00"
          elif [ "$COVERAGE_INT" -ge 80 ]; then
            COLOR="#a4a61d"
          elif [ "$COVERAGE_INT" -ge 70 ]; then
            COLOR="#dfb317"
          else
            COLOR="#e05d44"
          fi

          # Generate coverage badge
          mkdir -p assets
          cat > assets/coverage.svg << SVGEOF
          <svg xmlns="http://www.w3.org/2000/svg" width="106" height="20">
          <linearGradient id="b" x2="0" y2="100%"><stop offset="0" stop-color="#bbb" stop-opacity=".1"/><stop offset="1" stop-opacity=".1"/></linearGradient>
          <mask id="a"><rect width="106" height="20" rx="3" fill="#fff"/></mask>
          <g mask="url(#a)"><path fill="#555" d="M0 0h61v20H0z"/><path fill="${COLOR}" d="M61 0h45v20H61z"/><path fill="url(#b)" d="M0 0h106v20H0z"/></g>
          <g fill="#fff" text-anchor="middle" font-family="DejaVu Sans,Verdana,Geneva,sans-serif" font-size="11">
          <text x="30.5" y="15" fill="#010101" fill-opacity=".3">coverage</text>
          <text x="30.5" y="14">coverage</text>
          <text x="83" y="15" fill="#010101" fill-opacity=".3">${COVERAGE_INT}%</text>
          <text x="83" y="14">${COVERAGE_INT}%</text></g></svg>
          SVGEOF

      - name: Commit coverage badge
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add assets/coverage.svg
          git diff --staged --quiet || git commit -m "chore(java): update coverage badge [skip ci]"
          git push

  docs:
    runs-on: ubuntu-latest
    needs: build-and-test

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      - name: Run tests and generate HTML report
        run: |
          mkdir -p build/docs/tests
          mvn test surefire-report:report-only site -DgenerateReports=false
          cp target/site/surefire-report.html build/docs/tests/index.html
          cp -r target/site/css build/docs/tests/ 2>/dev/null || true

      - name: Generate API documentation
        run: |
          mvn javadoc:javadoc
          cp -r target/site/apidocs build/docs/api

      - name: Add docs summary
        run: |
          echo "## Documentation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Generated artifacts:" >> $GITHUB_STEP_SUMMARY
          echo "- **API docs**: \`build/docs/api/\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Test report**: \`build/docs/tests/index.html\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Download the **docs** artifact to view all documentation." >> $GITHUB_STEP_SUMMARY

      - name: Upload documentation artifacts
        uses: actions/upload-artifact@v4
        with:
          name: docs
          path: implementations/java/build/docs
          retention-days: 7
